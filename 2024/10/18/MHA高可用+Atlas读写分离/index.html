

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Taozi">
  <meta name="keywords" content="">
  
    <meta name="description" content="高可用架构方案123456负载均衡:有一定的高可用性 LVS  Nginx主备系统:有高可用性,需要切换,单活架构keepalived,  MHA, MMM真正高可用(多活-并发): NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC  主从架构演变介绍基础架构123456一主一从一主多从双主多级主从">
<meta property="og:type" content="article">
<meta property="og:title" content="MHA高可用+Atlas读写分离">
<meta property="og:url" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/index.html">
<meta property="og:site_name" content="Taozi">
<meta property="og:description" content="高可用架构方案123456负载均衡:有一定的高可用性 LVS  Nginx主备系统:有高可用性,需要切换,单活架构keepalived,  MHA, MMM真正高可用(多活-并发): NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC  主从架构演变介绍基础架构123456一主一从一主多从双主多级主从">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113416352.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113503674.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113517921.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105629154.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105634345.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018155325464.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018160652891.png">
<meta property="article:published_time" content="2024-10-18T13:54:48.000Z">
<meta property="article:modified_time" content="2024-10-19T02:51:50.441Z">
<meta property="article:author" content="Taozi">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="MHA">
<meta property="article:tag" content="Atlas">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>MHA高可用+Atlas读写分离 - Taozi</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yftxhy.cn","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"?06a5d424ca58db4d2bcc51280f4bbb00","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js??06a5d424ca58db4d2bcc51280f4bbb00";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Taozi</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MHA高可用+Atlas读写分离"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-10-18 21:54" pubdate>
          2024年10月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MHA高可用+Atlas读写分离</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="高可用架构方案"><a href="#高可用架构方案" class="headerlink" title="高可用架构方案"></a>高可用架构方案</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">负载均衡:有一定的高可用性 <br>LVS  Nginx<br>主备系统:有高可用性,需要切换,单活架构<br>keepalived,  MHA, MMM<br>真正高可用(多活-并发): <br>NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC<br></code></pre></td></tr></table></figure>

<h3 id="主从架构演变介绍"><a href="#主从架构演变介绍" class="headerlink" title="主从架构演变介绍"></a>主从架构演变介绍</h3><h4 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">一主一从<br>一主多从<br>双主<br>多级主从<br>循环复制<br>MGR<br></code></pre></td></tr></table></figure>

<h4 id="高级应用架构"><a href="#高级应用架构" class="headerlink" title="高级应用架构"></a>高级应用架构</h4><h5 id="高性能架构"><a href="#高性能架构" class="headerlink" title="高性能架构"></a>高性能架构</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 读写分离架构(读性能较高)：<br>Atlas;Mysql Router;Cobar;proxySQL;Maxcale;Mycat<br><br><span class="hljs-bullet">2.</span> 分布式架构(读写性能都提高)：<br>Atlas；Mycat(开源)；TDDL；Innodb Cluster<br></code></pre></td></tr></table></figure>

<h5 id="高可用架构"><a href="#高可用架构" class="headerlink" title="高可用架构"></a>高可用架构</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 单活(可切换):<br>MMM架构——Keepalived+2主+1从;MHA架构(1主2从);TMHA(1主1从) <br><span class="hljs-bullet">2.</span> 多活:<br>Innodb Cluster;MGC(MariaDB Galera Cluster)架构;PXC)(Percona XtraDB Cluster);MySQL Cluster(Oracle rac)架构<br></code></pre></td></tr></table></figure>

<h3 id="高可用MHA"><a href="#高可用MHA" class="headerlink" title="高可用MHA"></a>高可用MHA</h3><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">主库宕机处理过程<br><span class="hljs-bullet">1.</span> 监控节点 (通过配置文件获取所有节点信息)<br>   系统,网络,SSH连接性<br>   主从状态,重点是主库<br><br><span class="hljs-bullet">2.</span> 选主<br>(1) 如果判断从库(position或者GTID),数据有差异,最接近于Master的slave,成为备选主<br>(2) 如果判断从库(position或者GTID),数据一致,按照配置文件顺序,选主.<br>(3) 如果设定有权重(candidate<span class="hljs-emphasis">_master=1),按照权重强制指定备选主.</span><br><span class="hljs-emphasis">    1. 默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重,也会失效.</span><br><span class="hljs-emphasis">    2. 如果check_</span>repl<span class="hljs-emphasis">_delay=0的化,即使落后很多日志,也强制选择其为备选主</span><br><span class="hljs-emphasis">3. 数据补偿</span><br><span class="hljs-emphasis">(1) 当SSH能连接,从库对比主库GTID 或者position号,立即将二进制日志保存至各个从节点并且应用(save_</span>binary<span class="hljs-emphasis">_logs )</span><br><span class="hljs-emphasis">(2) 当SSH不能连接, 对比从库之间的relaylog的差异(apply_</span>diff<span class="hljs-emphasis">_relay_</span>logs) <br><span class="hljs-bullet">4.</span> Failover<br>将备选主进行身份切换,对外提供服务<br>其余从库和新主库确认新的主从关系<br><span class="hljs-bullet">5.</span> 应用透明(VIP)<br>MHA自带<br><span class="hljs-bullet">6.</span> 故障切换通知(send<span class="hljs-emphasis">_reprt)</span><br><span class="hljs-emphasis">7. 二次数据补偿(binlog_</span>server)<br></code></pre></td></tr></table></figure>

<h4 id="软件包构成"><a href="#软件包构成" class="headerlink" title="软件包构成"></a>软件包构成</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Manager工具包主要包括以下几个工具：<br>masterha<span class="hljs-emphasis">_manger             启动MHA的脚本</span><br><span class="hljs-emphasis">masterha_</span>stop               关闭Manager<br>masterha<span class="hljs-emphasis">_check_</span>ssh          检查MHA的SSH配置状况 <br>masterha<span class="hljs-emphasis">_check_</span>repl         检查MySQL复制状况 <br>masterha<span class="hljs-emphasis">_master_</span>monitor     检测master是否宕机 <br>masterha<span class="hljs-emphasis">_check_</span>status       检测当前MHA运行状态 <br>masterha<span class="hljs-emphasis">_master_</span>switch      控制故障转移（自动或者手动）<br>masterha<span class="hljs-emphasis">_conf_</span>host          添加或删除配置的server信息<br><br>Node工具包主要包括以下几个工具：<br>这些工具通常由MHA Manager的脚本触发，无需人为操作<br>save<span class="hljs-emphasis">_binary_</span>logs            保存和复制master的二进制日志 <br>apply<span class="hljs-emphasis">_diff_</span>relay<span class="hljs-emphasis">_logs       识别差异的中继日志事件并将其差异的事件应用于其他的</span><br><span class="hljs-emphasis">purge_</span>relay<span class="hljs-emphasis">_logs            清除中继日志（不会阻塞SQL线程）</span><br></code></pre></td></tr></table></figure>

<h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><table>
<thead>
<tr>
<th>主库</th>
<th>从库1</th>
<th>从库2</th>
<th>MySQL版本</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
<td>5.7.41</td>
</tr>
<tr>
<td>node</td>
<td>node</td>
<td>node、manager、binlogserver</td>
<td></td>
</tr>
</tbody></table>
<h4 id="配置关键程序软链接"><a href="#配置关键程序软链接" class="headerlink" title="配置关键程序软链接"></a>配置关键程序软链接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s /web/soft/mysql/bin/mysqlbinlog    /usr/bin/mysqlbinlog<br>ln -s /web/soft/mysql/bin/mysql          /usr/bin/mysql<br></code></pre></td></tr></table></figure>

<p>一主两从开启GTID</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">主库：<br>192.168.177.200    node<br>从库：<br>192.168.177.201    node  <br>192.168.177.202    node manager<br></code></pre></td></tr></table></figure>

<h4 id="配置各节点互信"><a href="#配置各节点互信" class="headerlink" title="配置各节点互信"></a>配置各节点互信</h4><p>主</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">rm -rf /root/.ssh <br>ssh-keygen<br>cd /root/.ssh <br>mv id_rsa.pub authorized_keys<br>scp -r /root/.ssh 192.168.177.201:/root <br>scp -r /root/.ssh 192.168.177.202:/root<br></code></pre></td></tr></table></figure>

<p>验证</p>
<p>主</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh 192.168.177.200 date<br>ssh 192.168.177.201 date<br>ssh 192.168.177.202 date<br></code></pre></td></tr></table></figure>

<p>从1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh 192.168.177.200 date<br>ssh 192.168.177.201 date<br>ssh 192.168.177.202 date<br></code></pre></td></tr></table></figure>

<p>从2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh 192.168.177.200 date<br>ssh 192.168.177.201 date<br>ssh 192.168.177.202 date<br></code></pre></td></tr></table></figure>

<h3 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h3><h4 id="所有节点"><a href="#所有节点" class="headerlink" title="所有节点"></a>所有节点</h4><p>下载MHA软件</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">node</span>:<br>http://www.mysql.gr.jp/frame/modules/bwiki/index.php?plugin=attach&amp;pcmd=open&amp;file=mha4mysql-node-0.56-0.el6.noarch.rpm&amp;refer=matsunobu<br><span class="hljs-attribute">manager</span>:<br>http://www.mysql.gr.jp/frame/modules/bwiki/index.php?plugin=attach&amp;pcmd=open&amp;file=mha4mysql-manager-0.56-0.el6.noarch.rpm&amp;refer=matsunobu<br></code></pre></td></tr></table></figure>

<p>Node软件安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install perl-DBD-MySQL -y<br>rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<h4 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h4><p>创建MHA专用用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;mha&#x27;</span>@<span class="hljs-string">&#x27;192.168.177.%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush privileges;<br><br>创建好用户后三个节点查询用户是否创建成功：<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>,host <span class="hljs-keyword">from</span> mysql.user;<br></code></pre></td></tr></table></figure>

<h4 id="从库2"><a href="#从库2" class="headerlink" title="从库2"></a>从库2</h4><p>Manager软件安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes<br>rpm -ivh mha4mysql-manager-0.56-0.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<p>Manager配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">创建配置文件目录<br>mkdir -p /etc/mha/<br>创建日志目录<br>mkdir -p /web/logs/mysql/mha/<br>编辑mha配置文件<br>vim /etc/mha/mha.cnf<br><br>[server default]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">Manager工作日志</span><br>manager_log=/web/logs/mysql/mha/manager<br><span class="hljs-meta prompt_">#</span><span class="language-bash">存放日志位置</span><br>manager_workdir=/web/logs/mysql/mha <br><span class="hljs-meta prompt_">#</span><span class="language-bash">主库二进制日志位置</span><br>master_binlog_dir=/web/logs/mysql/binlog/   <br>user=mha                                   <br>password=123456<br><span class="hljs-meta prompt_">#</span><span class="language-bash">探测节点状态时间间隔(s)探测3次</span><br>ping_interval=2<br>repl_user=repl<br>repl_password=123456<br>ssh_user=root                               <br>[server1]                                   <br>hostname=192.168.177.200<br>port=3306                                  <br>[server2]            <br>hostname=192.168.177.201<br>port=3306<br>[server3]<br>hostname=192.168.177.202<br>port=3306<br></code></pre></td></tr></table></figure>

<p>额外参数</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">说明：<br>主库宕机谁来接管？<br><span class="hljs-bullet">1.</span> 所有从节点日志都是一致的，默认会以配置文件的顺序去选择一个新主。<br><span class="hljs-bullet">2.</span> 从节点日志不一致，自动选择最接近于主库的从库<br><span class="hljs-bullet">3.</span> 如果对于某节点设定了权重（candidate<span class="hljs-emphasis">_master=1），权重节点会优先选择。</span><br><span class="hljs-emphasis">但是此节点日志量落后主库100M日志的话，也不会被选择。可以配合check_</span>repl<span class="hljs-emphasis">_delay=0，关闭日志量的检查，强制选择候选节点。</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">#设置监控逐鹿，发送ping包的时间间隔，尝试三次没有回应的时候自动进行failover</span><br><span class="hljs-emphasis">ping_</span>interval=2<br><span class="hljs-section">#设置候选master，设置该参数后，发生主从切换以后将会将此库提升为主库即使这个主库不是集群中事件最新的</span><br>canditate<span class="hljs-emphasis">_master=1</span><br><span class="hljs-emphasis">#默认情况下如果一个slave落后master 100M的relay-logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_</span>repl<span class="hljs-emphasis">_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_</span>master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master.<br>check<span class="hljs-emphasis">_repl_</span>delay=0<br></code></pre></td></tr></table></figure>

<p>互信检查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell">masterha_check_ssh  --conf=/etc/mha/mha.cnf<br><br>[root@localhost mha]# masterha_check_ssh  --conf=/etc/mha/mha.cnf<br>Wed Oct 16 15:36:56 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br>Wed Oct 16 15:36:56 2024 - [info] Reading application default configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:36:56 2024 - [info] Reading server configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:36:56 2024 - [info] Starting SSH connection tests..<br>Wed Oct 16 15:36:58 2024 - [debug] <br>Wed Oct 16 15:36:56 2024 - [debug]  Connecting via SSH from root@192.168.177.200(192.168.177.200:22) to root@192.168.177.201(192.168.177.201:22)..<br>Wed Oct 16 15:36:57 2024 - [debug]   ok.<br>Wed Oct 16 15:36:57 2024 - [debug]  Connecting via SSH from root@192.168.177.200(192.168.177.200:22) to root@192.168.177.202(192.168.177.202:22)..<br>Wed Oct 16 15:36:58 2024 - [debug]   ok.<br>Wed Oct 16 15:36:59 2024 - [debug] <br>Wed Oct 16 15:36:57 2024 - [debug]  Connecting via SSH from root@192.168.177.202(192.168.177.202:22) to root@192.168.177.200(192.168.177.200:22)..<br>Wed Oct 16 15:36:58 2024 - [debug]   ok.<br>Wed Oct 16 15:36:58 2024 - [debug]  Connecting via SSH from root@192.168.177.202(192.168.177.202:22) to root@192.168.177.201(192.168.177.201:22)..<br>Wed Oct 16 15:36:59 2024 - [debug]   ok.<br>Wed Oct 16 15:36:59 2024 - [debug] <br>Wed Oct 16 15:36:56 2024 - [debug]  Connecting via SSH from root@192.168.177.201(192.168.177.201:22) to root@192.168.177.200(192.168.177.200:22)..<br>Wed Oct 16 15:36:57 2024 - [debug]   ok.<br>Wed Oct 16 15:36:57 2024 - [debug]  Connecting via SSH from root@192.168.177.201(192.168.177.201:22) to root@192.168.177.202(192.168.177.202:22)..<br>Wed Oct 16 15:36:58 2024 - [debug]   ok.<br>Wed Oct 16 15:36:59 2024 - [info] All SSH connection tests passed successfully.[root@localhost mha]# masterha_check_ssh  --conf=/etc/mha/mha.cnf<br>Wed Oct 16 15:47:19 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br>Wed Oct 16 15:47:19 2024 - [info] Reading application default configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:47:19 2024 - [info] Reading server configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:47:19 2024 - [info] Starting SSH connection tests..<br>Wed Oct 16 15:47:22 2024 - [debug] <br>Wed Oct 16 15:47:19 2024 - [debug]  Connecting via SSH from root@192.168.177.200(192.168.177.200:22) to root@192.168.177.201(192.168.177.201:22)..<br>Wed Oct 16 15:47:20 2024 - [debug]   ok.<br>Wed Oct 16 15:47:20 2024 - [debug]  Connecting via SSH from root@192.168.177.200(192.168.177.200:22) to root@192.168.177.202(192.168.177.202:22)..<br>Wed Oct 16 15:47:22 2024 - [debug]   ok.<br>Wed Oct 16 15:47:23 2024 - [debug] <br>Wed Oct 16 15:47:20 2024 - [debug]  Connecting via SSH from root@192.168.177.201(192.168.177.201:22) to root@192.168.177.200(192.168.177.200:22)..<br>Wed Oct 16 15:47:21 2024 - [debug]   ok.<br>Wed Oct 16 15:47:21 2024 - [debug]  Connecting via SSH from root@192.168.177.201(192.168.177.201:22) to root@192.168.177.202(192.168.177.202:22)..<br>Wed Oct 16 15:47:22 2024 - [debug]   ok.<br>Wed Oct 16 15:47:23 2024 - [debug] <br>Wed Oct 16 15:47:20 2024 - [debug]  Connecting via SSH from root@192.168.177.202(192.168.177.202:22) to root@192.168.177.200(192.168.177.200:22)..<br>Wed Oct 16 15:47:21 2024 - [debug]   ok.<br>Wed Oct 16 15:47:21 2024 - [debug]  Connecting via SSH from root@192.168.177.202(192.168.177.202:22) to root@192.168.177.201(192.168.177.201:22)..<br>Wed Oct 16 15:47:22 2024 - [debug]   ok.<br>Wed Oct 16 15:47:23 2024 - [info] All SSH connection tests passed successfully.<br></code></pre></td></tr></table></figure>

<p>主从状态检查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell"> masterha_check_repl  --conf=/etc/mha/mha.cnf<br> <br>[root@localhost mha]# masterha_check_repl  --conf=/etc/mha/mha.cnf<br>Wed Oct 16 15:46:48 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br>Wed Oct 16 15:46:48 2024 - [info] Reading application default configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:46:48 2024 - [info] Reading server configuration from /etc/mha/mha.cnf..<br>Wed Oct 16 15:46:48 2024 - [info] MHA::MasterMonitor version 0.56.<br>Wed Oct 16 15:46:49 2024 - [info] GTID failover mode = 1<br>Wed Oct 16 15:46:49 2024 - [info] Dead Servers:<br>Wed Oct 16 15:46:49 2024 - [info] Alive Servers:<br>Wed Oct 16 15:46:49 2024 - [info]   192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [info]   192.168.177.201(192.168.177.201:3306)<br>Wed Oct 16 15:46:49 2024 - [info]   192.168.177.202(192.168.177.202:3306)<br>Wed Oct 16 15:46:49 2024 - [info] Alive Slaves:<br>Wed Oct 16 15:46:49 2024 - [info]   192.168.177.201(192.168.177.201:3306)  Version=5.7.41-log (oldest major version between slaves) log-bin:enabled<br>Wed Oct 16 15:46:49 2024 - [info]     GTID ON<br>Wed Oct 16 15:46:49 2024 - [info]     Replicating from 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [info]   192.168.177.202(192.168.177.202:3306)  Version=5.7.41-log (oldest major version between slaves) log-bin:enabled<br>Wed Oct 16 15:46:49 2024 - [info]     GTID ON<br>Wed Oct 16 15:46:49 2024 - [info]     Replicating from 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [info] Current Alive Master: 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [info] Checking slave configurations..<br>Wed Oct 16 15:46:49 2024 - [info]  read_only=1 is not set on slave 192.168.177.201(192.168.177.201:3306).<br>Wed Oct 16 15:46:49 2024 - [info]  read_only=1 is not set on slave 192.168.177.202(192.168.177.202:3306).<br>Wed Oct 16 15:46:49 2024 - [info] Checking replication filtering settings..<br>Wed Oct 16 15:46:49 2024 - [info]  binlog_do_db= , binlog_ignore_db= <br>Wed Oct 16 15:46:49 2024 - [info]  Replication filtering check ok.<br>Wed Oct 16 15:46:49 2024 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.<br>Wed Oct 16 15:46:49 2024 - [info] Checking SSH publickey authentication settings on the current master..<br>Wed Oct 16 15:46:50 2024 - [info] HealthCheck: SSH to 192.168.177.200 is reachable.<br>Wed Oct 16 15:46:50 2024 - [info] <br>192.168.177.200(192.168.177.200:3306) (current master)<br> +--192.168.177.201(192.168.177.201:3306)<br> +--192.168.177.202(192.168.177.202:3306)<br><br>Wed Oct 16 15:46:50 2024 - [info] Checking replication health on 192.168.177.201..<br>Wed Oct 16 15:46:50 2024 - [info]  ok.<br>Wed Oct 16 15:46:50 2024 - [info] Checking replication health on 192.168.177.202..<br>Wed Oct 16 15:46:50 2024 - [info]  ok.<br>Wed Oct 16 15:46:50 2024 - [warning] master_ip_failover_script is not defined.<br>Wed Oct 16 15:46:50 2024 - [warning] shutdown_script is not defined.<br>Wed Oct 16 15:46:50 2024 - [info] Got exit code 0 (Not master dead).<br><br>MySQL Replication Health is OK.<br></code></pre></td></tr></table></figure>

<p>开启MHA</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure>

<p>查看MHA工作状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">masterha_check_status --conf=/etc/mha/mha.cnf<br><br>[root@localhost mha]# masterha_check_status --conf=/etc/mha/mha.cnf<br>mha (pid:7022) is running(0:PING_OK), master:192.168.177.200<br><br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.200 -e &quot;show variables like &#x27;server_id&#x27;&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 1     |<br>+---------------+-------+<br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.201 -e &quot;show variables like &#x27;server_id&#x27;&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 2     |<br>+---------------+-------+<br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.202 -e &quot;show variables like &#x27;server_id&#x27;&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 3     |<br>+---------------+-------+<br></code></pre></td></tr></table></figure>

<h3 id="故障模拟及处理"><a href="#故障模拟及处理" class="headerlink" title="故障模拟及处理"></a>故障模拟及处理</h3><p>停主库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">/etc/init.d/mysql stop<br><br>观察manager的日志 tail -100f /web/logs/mysql/mha/manager.log<br>末尾必须显示successfully，才算正常切换成功。  <br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@localhost mha]# cat /etc/mha/mha.cnf <br>[server default]<br>manager_log=/web/logs/mysql/mha/manager<br>manager_workdir=/web/logs/mysql/mha<br>master_binlog_dir=/web/logs/mysql/binlog/<br>password=123456<br>ping_interval=2<br>repl_password=123456<br>repl_user=repl<br>ssh_user=root<br>user=mha<br><br>[server2]<br>hostname=192.168.177.201<br>port=3306<br><br>[server3]<br>hostname=192.168.177.202<br>port=3306<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show slave status \G</span><br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.177.201<br>                  Master_User: repl<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 1713<br>               Relay_Log_File: localhost-relay-bin.000002<br>                Relay_Log_Pos: 414<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>            <br>[root@localhost mha]# tail -f /web/logs/mysql/mha/manager<br>Master 192.168.177.200(192.168.177.200:3306) is down!<br><br>Check MHA Manager logs at localhost.localdomain:/web/logs/mysql/mha/manager for details.<br><br>Started automated(non-interactive) failover.<br>Selected 192.168.177.201(192.168.177.201:3306) as a new master.<br>192.168.177.201(192.168.177.201:3306): OK: Applying all logs succeeded.<br>192.168.177.202(192.168.177.202:3306): OK: Slave started, replicating from 192.168.177.201(192.168.177.201:3306)<br>192.168.177.201(192.168.177.201:3306): Resetting slave info succeeded.<br>Master failover to 192.168.177.201(192.168.177.201:3306) completed successfully<br></code></pre></td></tr></table></figure>

<p>恢复主库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/etc/init.d/mysql start<br></code></pre></td></tr></table></figure>

<p>恢复主从结构(主库执行)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">tail -200f /web/logs/mysql/mha/manager  可以查看到构建主从的语句<br>CHANGE MASTER TO MASTER_HOST=&#x27;192.168.177.201&#x27;, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123456&#x27;;<br></code></pre></td></tr></table></figure>

<p>恢复Manager配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/mha/mha.cnf <br>[server1]                                   <br>hostname=192.168.177.200<br>port=3306 <br></code></pre></td></tr></table></figure>

<p>启动MHA</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure>

<h3 id="主从库已变更"><a href="#主从库已变更" class="headerlink" title="主从库已变更"></a>主从库已变更</h3><table>
<thead>
<tr>
<th>从库1</th>
<th>主库</th>
<th>从库2</th>
<th>MySQL版本</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
<td>5.7.41</td>
</tr>
</tbody></table>
<h3 id="MHA-vip配置"><a href="#MHA-vip配置" class="headerlink" title="MHA vip配置"></a>MHA vip配置</h3><p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">master_ip_failover_script=/etc/mha/master_ip_failover<br>注意：/etc/mha/master_ip_failover，必须事先准备好<br></code></pre></td></tr></table></figure>

<p>添加脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim  /etc/mha/master_ip_failover<br><br>chmod +x /etc/mha/master_ip_failover<br>dos2unix /etc/mha/master_ip_failover    转换中文字符<br></code></pre></td></tr></table></figure>

<p>vip漂移脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/usr/bin/env perl</span><br><br>use strict;<br>use warnings FATAL =&gt; &#x27;all&#x27;;<br>use Getopt::Long;<br><br>my (<br>    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,<br>    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port<br>);<br><br>my $vip = &#x27;192.168.177.218/24&#x27;;<br>my $key = &#x27;1&#x27;;<br>my $ssh_start_vip = &quot;/sbin/ifconfig ens33:$key $vip&quot;;<br>my $ssh_stop_vip = &quot;/sbin/ifconfig ens33:$key down&quot;; # 确保接口名称一致<br><br>GetOptions(<br>    &#x27;command=s&#x27;          =&gt; \$command,<br>    &#x27;ssh_user=s&#x27;         =&gt; \$ssh_user,<br>    &#x27;orig_master_host=s&#x27; =&gt; \$orig_master_host,<br>    &#x27;orig_master_ip=s&#x27;   =&gt; \$orig_master_ip,<br>    &#x27;orig_master_port=i&#x27; =&gt; \$orig_master_port,<br>    &#x27;new_master_host=s&#x27;  =&gt; \$new_master_host,<br>    &#x27;new_master_ip=s&#x27;    =&gt; \$new_master_ip,<br>    &#x27;new_master_port=i&#x27;  =&gt; \$new_master_port,<br>);<br><br>exit &amp;main();<br><br>sub main &#123;<br>    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;<br>    print &quot;\n\nIN Master_ip_failover_command:====$command===\n\n&quot;;<br><br>    if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;<br>        my $exit_code = 1;<br>        eval &#123;<br>            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;<br>            stop_vip();<br>            $exit_code = 0;<br>        &#125;;<br>        if ($@) &#123;<br>            warn &quot;Got Error: $@\n&quot;;<br>            exit $exit_code;<br>        &#125;<br>        exit $exit_code;<br>    &#125;<br>    elsif ( $command eq &quot;start&quot; ) &#123;<br>        my $exit_code = 10;<br>        eval &#123;<br>            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;<br>            start_vip();<br>            $exit_code = 0;<br>        &#125;;<br>        if ($@) &#123;<br>            warn $@;<br>            exit $exit_code;<br>        &#125;<br>        exit $exit_code;<br>    &#125;<br>    elsif ( $command eq &quot;status&quot; ) &#123;<br>        print &quot;Checking the Status of the script.. OK \n&quot;;<br>        exit 0;<br>    &#125;<br>    else &#123;<br>        usage();<br>        exit 1;<br>    &#125;<br>&#125;<br><br>sub start_vip &#123;<br>    my $output = qx&#123;ssh $ssh_user\@$new_master_host &quot;$ssh_start_vip&quot;&#125;;<br>    if ($?) &#123;<br>        die &quot;Failed to start VIP: $output&quot;;<br>    &#125;<br>&#125;<br><br>sub stop_vip &#123;<br>    return 0 unless ($ssh_user);<br>    my $output = qx&#123;ssh $ssh_user\@$orig_master_host &quot;$ssh_stop_vip&quot;&#125;;<br>    if ($?) &#123;<br>        die &quot;Failed to stop VIP: $output&quot;;<br>    &#125;<br>&#125;<br><br>sub usage &#123;<br>    print &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>更改Manager配置文件 添加脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/mha/mha.cnf<br>[server default]<br>master_ip_failover_script=/etc/mha/master_ip_failover<br></code></pre></td></tr></table></figure>

<p>第一次配置vip时候，需要在主库手工生成vip</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">手工在主库上绑定vip，注意一定要和配置文件中的ethN一致，eth33:1(1是key指定的值)<br>yum install net-tools -y                 #没有ifconfig命令执行<br>ifconfig ens33:1 192.168.177.218/24<br>ip address add 192.168.228.218/24 dev ens33:1<br>ifconfig<br></code></pre></td></tr></table></figure>

<p>重启Manager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">masterha_stop --conf=/etc/mha/mha.cnf<br>nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br><br>检查状态<br>masterha_check_status --conf=/etc/mha/mha.cnf<br>mha (pid:8652) is running(0:PING_OK), master:192.168.177.201<br></code></pre></td></tr></table></figure>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>查看主库vip</p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113416352.png" srcset="/img/loading.gif" lazyload></p>
<p>停止主库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/etc/init.d/mysql stop<br></code></pre></td></tr></table></figure>

<p>查看主库vip及从库vip</p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113503674.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113517921.png" srcset="/img/loading.gif" lazyload></p>
<p>恢复主库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">启动<br>/etc/init.d/mysql stop<br>构建主从关系<br>CHANGE MASTER TO MASTER_HOST=&#x27;192.168.177.200&#x27;, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123456&#x27;;<br>启动slave<br>start slave;<br></code></pre></td></tr></table></figure>

<p>启动Manager并查看状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost mha]# nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br>[1] 8652<br>[root@localhost mha]# masterha_check_status --conf=/etc/mha/mha.cnf<br>mha (pid:8652) is running(0:PING_OK), master:192.168.177.200<br></code></pre></td></tr></table></figure>

<h3 id="邮件提醒"><a href="#邮件提醒" class="headerlink" title="邮件提醒"></a>邮件提醒</h3><p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">report_script=/etc/mha/mail<br></code></pre></td></tr></table></figure>

<p>Manager增加配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /etc/mha/mail/<br>vim /etc/mha/mha.cnf<br>[server default]<br>report_script=/etc/mha/mail/send<br></code></pre></td></tr></table></figure>

<p>重启MHA</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">masterha_stop --conf=/etc/mha/mha.cnf<br>nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure>

<h3 id="Binlog-Server"><a href="#Binlog-Server" class="headerlink" title="Binlog Server"></a>Binlog Server</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown">避免主MHA连接不上主库，导致从库数据差异，数据丢失  需要配置额外服务器<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /web/data/mysql/binserver<br><br>vim /etc/mha/app1.cnf <br>[binlog1]<br>no_master=1<br>hostname=192.168.177.202<br><span class="hljs-meta prompt_">#</span><span class="language-bash">不能跟原binlog目录一样</span><br>master_binlog_dir=/web/data/mysql/binserver/<br></code></pre></td></tr></table></figure>

<p>拉去主库binlog日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">将当前主库binlog拉过来（从00000X开始拉，之后的binlog会自动按顺序过来）<br>进入创建的目录<br>cd /web/data/mysql/binserver/<br>mysqlbinlog  -R --host=192.168.177.201 --user=mha --password=123456 --raw  --stop-never mysql-bin.000009 &amp;<br><br>注意：<br>拉取日志的起点,需要按照目前从库的已经获取到的二进制日志点为起点<br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show slave status \G;</span><br>*************************** 1. row ***************************<br>                  Master_Host: 192.168.177.201<br>              Master_Log_File: mysql-bin.000009<br><br>-R：                       表示以只读模式执行，防止对日志文件进行写入操作。<br>--host=192.168.177.200：   指定要连接的主库的 IP 地址。<br>--user=mha：               连接主库服务器的用户名。<br>--password=123456：        连接主库服务器的密码。<br>--raw：                    以原始格式输出二进制日志内容。<br>--stop-never：             持续运行，不断读取新产生的日志内容，不会自动停止<br></code></pre></td></tr></table></figure>

<p>启动MHA</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup masterha_manager --conf=/etc/mha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null&gt; /web/logs/mysql/mha/manager.log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure>

<h4 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown">主库宕机，binlogserver 自动停掉，manager 也会自动停止。<br>处理思路：<br><span class="hljs-bullet">1.</span> 删除之前的binlog，重新获取新主库的binlog到binlogserver中<br><span class="hljs-bullet">2.</span> 重新配置文件binlog server信息<br><span class="hljs-bullet">3.</span> 最后再启动MHA<br></code></pre></td></tr></table></figure>

<p>设置从库多线程并发复制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">指定从库用于并行执行 SQL 线程的数量<br>SET GLOBAL slave_parallel_workers = 4;<br>slave_parallel_type：设置并行复制的类型<br>SET GLOBAL slave_parallel_type=&#x27;LOGICAL_CLOCK&#x27;;<br>重启复制线程<br>STOP SLAVE;<br>START SLAVE;<br></code></pre></td></tr></table></figure>

<h3 id="Atlas读写分离"><a href="#Atlas读写分离" class="headerlink" title="Atlas读写分离"></a>Atlas读写分离</h3><p>MHA+Atlas</p>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105629154.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105634345.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Atlas是由 Qihoo 360, Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。它是在mysql-proxy 0.8.2版本的基础上，对其进行了优化，增加了一些新的功能特性。<br>360内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。<br>下载地址<br>https://github.com/Qihoo360/Atlas/releases<br>注意：<br><span class="hljs-bullet">1.</span> Atlas只能安装运行在64位的系统上<br><span class="hljs-bullet">2.</span> Centos 5.X安装 Atlas-XX.el5.x86<span class="hljs-emphasis">_64.rpm，Centos 6.X安装Atlas-XX.el6.x86_</span>64.rpm。<br><span class="hljs-bullet">3.</span> 后端mysql版本应大于5.1，建议使用Mysql 5.6以上<br></code></pre></td></tr></table></figure>

<p>下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://objects.githubusercontent.com/github-production-release-asset-2e65be/15279980/39ac0594-8600-11e4-9ad6-7fc203cad2de?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=releaseassetproduction%2F20241018%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20241018T030903Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=5bfd9678cb16fee876e6f6a3af89b858a41f5840485524604c559ab8da9bc290&amp;X-Amz-SignedHeaders=host&amp;response-content-disposition=attachment%3B%20filename%3DAtlas-2.2.1.el6.x86_64.rpm&amp;response-content-type=application%2Foctet-stream<br></code></pre></td></tr></table></figure>

<h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">rpm -ivh Atlas-2.2.1.el6.x86_64.rpm<br><br>创建日志文件夹<br>mkdir -p /web/logs/mysql/mysql-proxy/<br><br>cd /usr/local/mysql-proxy/<br>mv test.cnf test.cnf.bak<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>主库</th>
<th>从库1</th>
<th>从库2</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
</tr>
</tbody></table>
<p>密码加密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">进入Atlas下bin目录<br>加密密码<br>[root@localhost bin]# ./encrypt 123456<br>/iZxz+0GRoA=<br></code></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim test.cnf<br><br>[mysql-proxy]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">管理Atlas用户名密码</span><br>admin-username = atlas<br>admin-password = 123456<br><span class="hljs-meta prompt_">#</span><span class="language-bash">负责写入的服务器iP</span><br>proxy-backend-addresses = 192.168.177.218:3306<br><span class="hljs-meta prompt_">#</span><span class="language-bash">负责读的节点(从库)</span><br>proxy-read-only-backend-addresses = 192.168.177.201:3306,192.168.177.202:3306<br>pwds = repl:/iZxz+0GRoA=,mha:/iZxz+0GRoA=<br>daemon = true<br>keepalive = true<br>event-threads = 8<br>log-level = message<br>log-path = /web/logs/mysql/mysql-proxy/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">是否记录操作日志</span><br>sql-log=ON<br>proxy-address = 0.0.0.0:33060<br>admin-address = 0.0.0.0:2345<br>charset=utf8<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/mysql-proxy/bin/mysql-proxyd test start<br></code></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">ps -ef |grep proxy<br>netstat -lntp |grep 33060<br>tcp        0      0 0.0.0.0:33060           0.0.0.0:*               LISTEN      55015/mysql-proxy <br><br>netstat -lntp |grep 2345<br>tcp        0      0 0.0.0.0:2345            0.0.0.0:*               LISTEN      55015/mysql-proxy <br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">-</span>u mha <span class="hljs-operator">-</span>p123456 <span class="hljs-operator">-</span>h <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.202</span> <span class="hljs-operator">-</span>P <span class="hljs-number">33060</span><br>查询<br><span class="hljs-keyword">select</span> @<span class="hljs-variable">@server_id</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018155325464.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">写入<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<span class="hljs-keyword">select</span> @<span class="hljs-variable">@server_id</span>;<span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018160652891.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="生产用户要求"><a href="#生产用户要求" class="headerlink" title="生产用户要求"></a>生产用户要求</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">开发人员申请一个应用用户 deploy(  select  update  insert)  密码123456,要通过192网段登录<br><span class="hljs-bullet">1.</span> 在主库中,创建用户<br>grant select ,update,insert on <span class="hljs-emphasis">*.*</span> to deploy@&#x27;192.168.177.%&#x27; identified by &#x27;123456&#x27;;<br><span class="hljs-bullet">2.</span> 在atlas中添加生产用户<br>/usr/local/mysql-proxy/bin/encrypt  123456      ----&gt;制作加密密码<br>vim test.cnf<br>pwds = repl:/iZxz+0GRoA=,mha:/iZxz+0GRoA=,deploy:/iZxz+0GRoA=<br><br>/usr/local/mysql-proxy/bin/mysql-proxyd test restart<br>mysql -u deploy -p123456 -h 192.168.177.202 -P 33060<br></code></pre></td></tr></table></figure>

<h3 id="Atlas基本管理"><a href="#Atlas基本管理" class="headerlink" title="Atlas基本管理"></a>Atlas基本管理</h3><p>连接管理接口</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mysql</span> -u Atlas -p <span class="hljs-number">123456</span> -h<span class="hljs-number">127.0.0.1</span> -P2345<br></code></pre></td></tr></table></figure>

<p>打印帮助</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> help;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> command                    <span class="hljs-operator">|</span> description                                             <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------+---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> help         <span class="hljs-operator">|</span> shows this help                                         <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> backends     <span class="hljs-operator">|</span> lists the backends <span class="hljs-keyword">and</span> their state                      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">SET</span> OFFLINE $backend_id    <span class="hljs-operator">|</span> offline backend server, $backend_id <span class="hljs-keyword">is</span> backend_ndx<span class="hljs-string">&#x27;s id |</span><br><span class="hljs-string">| SET ONLINE $backend_id     | online backend server, ...                              |</span><br><span class="hljs-string">| ADD MASTER $backend        | example: &quot;add master 127.0.0.1:3306&quot;, ...               |</span><br><span class="hljs-string">| ADD SLAVE $backend         | example: &quot;add slave 127.0.0.1:3306&quot;, ...                |</span><br><span class="hljs-string">| REMOVE BACKEND $backend_id | example: &quot;remove backend 1&quot;, ...                        |</span><br><span class="hljs-string">| SELECT * FROM clients      | lists the clients                                       |</span><br><span class="hljs-string">| ADD CLIENT $client         | example: &quot;add client 192.168.1.2&quot;, ...                  |</span><br><span class="hljs-string">| REMOVE CLIENT $client      | example: &quot;remove client 192.168.1.2&quot;, ...               |</span><br><span class="hljs-string">| SELECT * FROM pwds         | lists the pwds                                          |</span><br><span class="hljs-string">| ADD PWD $pwd               | example: &quot;add pwd user:raw_password&quot;, ...               |</span><br><span class="hljs-string">| ADD ENPWD $pwd             | example: &quot;add enpwd user:encrypted_password&quot;, ...       |</span><br><span class="hljs-string">| REMOVE PWD $pwd            | example: &quot;remove pwd user&quot;, ...                         |</span><br><span class="hljs-string">| SAVE CONFIG                | save the backends to config file                        |</span><br><span class="hljs-string">| SELECT VERSION             | display the version of Atlas                            |</span><br><span class="hljs-string">+----------------------------+---------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>

<p>查询后端所有节点信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> backends    ;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------------+-------+------+</span><br><span class="hljs-operator">|</span> backend_ndx <span class="hljs-operator">|</span> address              <span class="hljs-operator">|</span> state <span class="hljs-operator">|</span> type <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------------+-------+------+</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.218</span>:<span class="hljs-number">3306</span> <span class="hljs-operator">|</span> up    <span class="hljs-operator">|</span> rw   <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">2</span> <span class="hljs-operator">|</span> <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.201</span>:<span class="hljs-number">3306</span> <span class="hljs-operator">|</span> up    <span class="hljs-operator">|</span> ro   <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">3</span> <span class="hljs-operator">|</span> <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.202</span>:<span class="hljs-number">3306</span> <span class="hljs-operator">|</span> up    <span class="hljs-operator">|</span> ro   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------------+-------+------+</span><br></code></pre></td></tr></table></figure>

<p>动态删除节点</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">REMOVE BACKEND <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure>

<p>动态添加节点</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ADD</span> SLAVE <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.202</span>:<span class="hljs-number">3306</span>;<br></code></pre></td></tr></table></figure>

<p>保存</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">SAVE CONFIG;<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/MySQL/" class="category-chain-item">MySQL</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/" class="print-no-link">#Linux</a>
      
        <a href="/tags/MySQL/" class="print-no-link">#MySQL</a>
      
        <a href="/tags/MHA/" class="print-no-link">#MHA</a>
      
        <a href="/tags/Atlas/" class="print-no-link">#Atlas</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MHA高可用+Atlas读写分离</div>
      <div>https://yftxhy.cn/2024/10/18/MHA高可用+Atlas读写分离/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Taozi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年10月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/10/15/MySQL%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA/" title="MySQL主从搭建">
                        <span class="hidden-mobile">MySQL主从搭建</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
