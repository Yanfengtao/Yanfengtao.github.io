

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Taozi">
  <meta name="keywords" content="">
  
    <meta name="description" content="高可用架构方案123456负载均衡:有一定的高可用性 LVS  Nginx主备系统:有高可用性,需要切换,单活架构keepalived,  MHA, MMM真正高可用(多活-并发): NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC  主从架构演变介绍基础架构123456一主一从一主多从双主多级主从">
<meta property="og:type" content="article">
<meta property="og:title" content="MHA高可用+Atlas读写分离">
<meta property="og:url" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/index.html">
<meta property="og:site_name" content="Taozi">
<meta property="og:description" content="高可用架构方案123456负载均衡:有一定的高可用性 LVS  Nginx主备系统:有高可用性,需要切换,单活架构keepalived,  MHA, MMM真正高可用(多活-并发): NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC  主从架构演变介绍基础架构123456一主一从一主多从双主多级主从">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113416352.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113503674.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113517921.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105629154.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105634345.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018155325464.png">
<meta property="og:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018160652891.png">
<meta property="article:published_time" content="2024-10-18T13:54:48.000Z">
<meta property="article:modified_time" content="2024-10-18T15:33:35.637Z">
<meta property="article:author" content="Taozi">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="MHA">
<meta property="article:tag" content="Atlas">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yftxhy.cn/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png">
  
  
  
  <title>MHA高可用+Atlas读写分离 - Taozi</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yftxhy.cn","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Taozi</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MHA高可用+Atlas读写分离"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-10-18 21:54" pubdate>
          2024年10月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MHA高可用+Atlas读写分离</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="高可用架构方案"><a href="#高可用架构方案" class="headerlink" title="高可用架构方案"></a>高可用架构方案</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">负载均衡:有一定的高可用性 </span><br>LVS  Nginx<br><span class="hljs-section">主备系统:有高可用性,需要切换,单活架构</span><br>keepalived,  MHA, MMM<br><span class="hljs-section">真正高可用(多活-并发): </span><br>NDB Cluster  Oracle RAC  Sysbase cluster   , InnoDB Cluster（MGR）,PXC , MGC<br></code></pre></td></tr></table></figure>

<h3 id="主从架构演变介绍"><a href="#主从架构演变介绍" class="headerlink" title="主从架构演变介绍"></a>主从架构演变介绍</h3><h4 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">一主一从<br>一主多从<br>双主<br>多级主从<br>循环复制<br>MGR<br></code></pre></td></tr></table></figure>

<h4 id="高级应用架构"><a href="#高级应用架构" class="headerlink" title="高级应用架构"></a>高级应用架构</h4><h5 id="高性能架构"><a href="#高性能架构" class="headerlink" title="高性能架构"></a>高性能架构</h5><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">读写分离架构(读性能较高)：<br>Atlas;Mysql Router;Cobar;proxySQL;Maxcale;Mycat<br><br>分布式架构(读写性能都提高)：<br>Atlas；<span class="hljs-built_in">Mycat</span>(开源)；TDDL；Innodb Cluster<br></code></pre></td></tr></table></figure>

<h5 id="高可用架构"><a href="#高可用架构" class="headerlink" title="高可用架构"></a>高可用架构</h5><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">单活(可切换):MMM架构——Keepalived+<span class="hljs-number">2</span>主+<span class="hljs-number">1</span>从;MHA架构(<span class="hljs-number">1</span>主<span class="hljs-number">2</span>从);<span class="hljs-built_in">TMHA</span>(<span class="hljs-number">1</span>主<span class="hljs-number">1</span>从) <br>多活:Innodb Cluster;<span class="hljs-built_in">MGC</span>(MariaDB Galera Cluster)架构;PXC)(Percona XtraDB Cluster);MySQL <span class="hljs-built_in">Cluster</span>(Oracle rac)架构<br></code></pre></td></tr></table></figure>

<h3 id="高可用MHA"><a href="#高可用MHA" class="headerlink" title="高可用MHA"></a>高可用MHA</h3><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">主库宕机处理过程<br><span class="hljs-number">1</span>. 监控节点 (通过配置文件获取所有节点信息)<br>   系统,网络,SSH连接性<br>   主从状态,重点是主库<br><br><span class="hljs-number">2</span>. 选主<br>(<span class="hljs-number">1</span>) 如果判断从库(position或者GTID),数据有差异,最接近于<span class="hljs-literal">Master</span>的<span class="hljs-literal">slave</span>,成为备选主<br>(<span class="hljs-number">2</span>) 如果判断从库(position或者GTID),数据一致,按照配置文件顺序,选主.<br>(<span class="hljs-number">3</span>) 如果设定有权重(<span class="hljs-attr">candidate_master=</span><span class="hljs-number">1</span>),按照权重强制指定备选主.<br>    <span class="hljs-number">1</span>. 默认情况下如果一个<span class="hljs-literal">slave</span>落后<span class="hljs-keyword">master</span> <span class="hljs-title">100M</span>的relay logs的话，即使有权重,也会失效.<br>    <span class="hljs-number">2</span>. 如果<span class="hljs-attr">check_repl_delay=</span><span class="hljs-number">0</span>的化,即使落后很多日志,也强制选择其为备选主<br><span class="hljs-number">3</span>. 数据补偿<br>(<span class="hljs-number">1</span>) 当SSH能连接,从库对比主库GTID 或者position号,立即将二进制日志保存至各个从节点并且应用(save_binary_logs )<br>(<span class="hljs-number">2</span>) 当SSH不能连接, 对比从库之间的relaylog的差异(apply_diff_relay_logs) <br><span class="hljs-number">4</span>. Failover<br>	将备选主进行身份切换,对外提供服务<br>	其余从库和新主库确认新的主从关系<br><span class="hljs-number">5</span>. 应用透明(VIP)<br>	MHA自带<br><span class="hljs-number">6</span>. 故障切换通知(send_reprt)<br><span class="hljs-number">7</span>. 二次数据补偿(binlog_server)<br></code></pre></td></tr></table></figure>

<h4 id="软件包构成"><a href="#软件包构成" class="headerlink" title="软件包构成"></a>软件包构成</h4><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">Manager工具包主要包括以下几个工具：<br>masterh<span class="hljs-built_in">a_manger</span>             启动MHA的脚本<br>masterh<span class="hljs-built_in">a_stop</span>               关闭Manager<br>masterh<span class="hljs-built_in">a_check</span>_ssh          检查MHA的SSH配置状况 <br>masterh<span class="hljs-built_in">a_check</span>_repl         检查MySQL复制状况 <br>masterh<span class="hljs-built_in">a_master</span>_monitor     检测master是否宕机 <br>masterh<span class="hljs-built_in">a_check</span>_status       检测当前MHA运行状态 <br>masterh<span class="hljs-built_in">a_master</span>_switch      控制故障转移（自动或者手动）<br>masterh<span class="hljs-built_in">a_conf</span>_host          添加或删除配置的server信息<br><br>Node工具包主要包括以下几个工具：<br>这些工具通常由MHA Manager的脚本触发，无需人为操作<br>save_binary_logs            保存和复制master的二进制日志 <br>apply_diff_relay_logs       识别差异的中继日志事件并将其差异的事件应用于其他的<br>purge_relay_logs            清除中继日志（不会阻塞SQL线程）<br></code></pre></td></tr></table></figure>

<h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><table>
<thead>
<tr>
<th>主库</th>
<th>从库1</th>
<th>从库2</th>
<th>MySQL版本</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
<td>5.7.41</td>
</tr>
<tr>
<td>node</td>
<td>node</td>
<td>node、manager、binlogserver</td>
<td></td>
</tr>
</tbody></table>
<h4 id="配置关键程序软链接"><a href="#配置关键程序软链接" class="headerlink" title="配置关键程序软链接"></a>配置关键程序软链接</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">ln -s <span class="hljs-regexp">/web/</span>soft<span class="hljs-regexp">/mysql/</span>bin<span class="hljs-regexp">/mysqlbinlog    /u</span>sr<span class="hljs-regexp">/bin/my</span>sqlbinlog<br>ln -s <span class="hljs-regexp">/web/</span>soft<span class="hljs-regexp">/mysql/</span>bin<span class="hljs-regexp">/mysql          /u</span>sr<span class="hljs-regexp">/bin/my</span>sql<br></code></pre></td></tr></table></figure>

<p>一主两从开启GTID</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">主库：<br><span class="hljs-number">192.168.177.200</span>    node<br>从库：<br><span class="hljs-number">192.168.177.201</span>    node  <br><span class="hljs-number">192.168.177.202</span>    node manager<br></code></pre></td></tr></table></figure>

<h4 id="配置各节点互信"><a href="#配置各节点互信" class="headerlink" title="配置各节点互信"></a>配置各节点互信</h4><p>主</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf /root/.ssh <br>ssh-keygen<br><span class="hljs-built_in">cd</span> /root/.ssh <br><span class="hljs-built_in">mv</span> id_rsa.pub authorized_keys<br>scp -r /root/.ssh 192.168.177.201:/root <br>scp -r /root/.ssh 192.168.177.202:/root<br></code></pre></td></tr></table></figure>

<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>主</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssh</span> <span class="hljs-number">192.168.177.200</span> date<br>ssh <span class="hljs-number">192.168.177.201</span> date<br>ssh <span class="hljs-number">192.168.177.202</span> date<br></code></pre></td></tr></table></figure>

<p>从1</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssh</span> <span class="hljs-number">192.168.177.200</span> date<br>ssh <span class="hljs-number">192.168.177.201</span> date<br>ssh <span class="hljs-number">192.168.177.202</span> date<br></code></pre></td></tr></table></figure>

<p>从2</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssh</span> <span class="hljs-number">192.168.177.200</span> date<br>ssh <span class="hljs-number">192.168.177.201</span> date<br>ssh <span class="hljs-number">192.168.177.202</span> date<br></code></pre></td></tr></table></figure>

<h3 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h3><h4 id="所有节点"><a href="#所有节点" class="headerlink" title="所有节点"></a>所有节点</h4><p>下载MHA软件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/yoshinorim/m</span>ha4mysql-manager<span class="hljs-regexp">/wiki/</span>Downloads<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241016150436973.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sas">node:<br>http://www.mysql.gr.jp/frame/modules/bwiki/<span class="hljs-keyword">index</span>.php?plugin=attach<span class="hljs-variable">&amp;pcmd</span>=open<span class="hljs-variable">&amp;file</span>=mha4mysql-node-0.56-0.el6.noarch.rpm<span class="hljs-variable">&amp;refer</span>=matsunobu<br>manager:<br>http://www.mysql.gr.jp/frame/modules/bwiki/<span class="hljs-keyword">index</span>.php?plugin=attach<span class="hljs-variable">&amp;pcmd</span>=open<span class="hljs-variable">&amp;file</span>=mha4mysql-manager-0.56-0.el6.noarch.rpm<span class="hljs-variable">&amp;refer</span>=matsunobu<br></code></pre></td></tr></table></figure>

<p>Node软件安装</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">yum</span> install perl-DBD-MySQL -y<br><span class="hljs-attribute">rpm</span> -ivh mha4mysql-node-<span class="hljs-number">0</span>.<span class="hljs-number">56</span>-<span class="hljs-number">0</span>.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<h4 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h4><p>创建MHA专用用户</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;mha&#x27;</span>@<span class="hljs-string">&#x27;192.168.177.%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush <span class="hljs-keyword">privileges</span>;<br><br>创建好用户后三个节点查询用户是否创建成功：<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>,host <span class="hljs-keyword">from</span> mysql.<span class="hljs-keyword">user</span>;<br></code></pre></td></tr></table></figure>

<h4 id="从库2"><a href="#从库2" class="headerlink" title="从库2"></a>从库2</h4><p>Manager软件安装</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">yum install -<span class="hljs-keyword">y</span> <span class="hljs-keyword">perl</span>-Config-Tiny epel-release <span class="hljs-keyword">perl</span>-Log-Dispatch <span class="hljs-keyword">perl</span>-Parallel-ForkManager <span class="hljs-keyword">perl</span>-Time-HiRes<br>rpm -ivh mha4mysql-manager-<span class="hljs-number">0.56</span>-<span class="hljs-number">0</span>.el6.noarch.rpm<br></code></pre></td></tr></table></figure>

<p>Manager配置</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs routeros">创建配置文件目录<br>mkdir -p /etc/mha/<br>创建日志目录<br>mkdir -p /web/logs/mysql/mha/<br>编辑mha配置文件<br>vim /etc/mha/mha.cnf<br><br>[server default]<br><span class="hljs-comment">#Manager工作日志</span><br><span class="hljs-attribute">manager_log</span>=/web/logs/mysql/mha/manager<br><span class="hljs-comment">#存放日志位置</span><br><span class="hljs-attribute">manager_workdir</span>=/web/logs/mysql/mha <br><span class="hljs-comment">#主库二进制日志位置</span><br><span class="hljs-attribute">master_binlog_dir</span>=/web/logs/mysql/binlog/   <br><span class="hljs-attribute">user</span>=mha                                   <br><span class="hljs-attribute">password</span>=123456<br><span class="hljs-comment">#探测节点状态时间间隔(s)探测3次</span><br><span class="hljs-attribute">ping_interval</span>=2<br><span class="hljs-attribute">repl_user</span>=repl<br><span class="hljs-attribute">repl_password</span>=123456<br><span class="hljs-attribute">ssh_user</span>=root                               <br>[server1]                                   <br><span class="hljs-attribute">hostname</span>=192.168.177.200<br><span class="hljs-attribute">port</span>=3306                                  <br>[server2]            <br><span class="hljs-attribute">hostname</span>=192.168.177.201<br><span class="hljs-attribute">port</span>=3306<br>[server3]<br><span class="hljs-attribute">hostname</span>=192.168.177.202<br><span class="hljs-attribute">port</span>=3306<br></code></pre></td></tr></table></figure>

<p>额外参数</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros">说明：<br>主库宕机谁来接管？<br>1. 所有从节点日志都是一致的，默认会以配置文件的顺序去选择一个新主。<br>2. 从节点日志不一致，自动选择最接近于主库的从库<br>3. 如果对于某节点设定了权重（<span class="hljs-attribute">candidate_master</span>=1），权重节点会优先选择。<br>但是此节点日志量落后主库100M日志的话，也不会被选择。可以配合<span class="hljs-attribute">check_repl_delay</span>=0，关闭日志量的检查，强制选择候选节点。<br><br><span class="hljs-comment">#设置监控逐鹿，发送ping包的时间间隔，尝试三次没有回应的时候自动进行failover</span><br><span class="hljs-attribute">ping_interval</span>=2<br><span class="hljs-comment">#设置候选master，设置该参数后，发生主从切换以后将会将此库提升为主库即使这个主库不是集群中事件最新的</span><br><span class="hljs-attribute">canditate_master</span>=1<br><span class="hljs-comment">#默认情况下如果一个slave落后master 100M的relay-logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master.</span><br><span class="hljs-attribute">check_repl_delay</span>=0<br></code></pre></td></tr></table></figure>

<p>互信检查</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs routeros">masterha_check_ssh  <span class="hljs-attribute">--conf</span>=/etc/mha/mha.cnf<br><br>[root@localhost mha]# masterha_check_ssh  <span class="hljs-attribute">--conf</span>=/etc/mha/mha.cnf<br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="hljs-keyword">not</span> found. Skipping.<br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">info</span>] Reading application<span class="hljs-built_in"> default </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">info</span>] Reading<span class="hljs-built_in"> server </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">info</span>] Starting SSH<span class="hljs-built_in"> connection </span>tests<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:58 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.200(192.168.177.200:22) <span class="hljs-keyword">to</span> root@192.168.177.201(192.168.177.201:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:57 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:57 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.200(192.168.177.200:22) <span class="hljs-keyword">to</span> root@192.168.177.202(192.168.177.202:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:58 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:59 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:36:57 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.202(192.168.177.202:22) <span class="hljs-keyword">to</span> root@192.168.177.200(192.168.177.200:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:58 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:58 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.202(192.168.177.202:22) <span class="hljs-keyword">to</span> root@192.168.177.201(192.168.177.201:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:59 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:59 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:36:56 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.201(192.168.177.201:22) <span class="hljs-keyword">to</span> root@192.168.177.200(192.168.177.200:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:57 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:57 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.201(192.168.177.201:22) <span class="hljs-keyword">to</span> root@192.168.177.202(192.168.177.202:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:36:58 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:36:59 2024 - [<span class="hljs-built_in">info</span>] All SSH<span class="hljs-built_in"> connection </span>tests passed successfully.[root@localhost mha]# masterha_check_ssh  <span class="hljs-attribute">--conf</span>=/etc/mha/mha.cnf<br>Wed Oct 16 15:47:19 2024 - [<span class="hljs-built_in">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="hljs-keyword">not</span> found. Skipping.<br>Wed Oct 16 15:47:19 2024 - [<span class="hljs-built_in">info</span>] Reading application<span class="hljs-built_in"> default </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:19 2024 - [<span class="hljs-built_in">info</span>] Reading<span class="hljs-built_in"> server </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:19 2024 - [<span class="hljs-built_in">info</span>] Starting SSH<span class="hljs-built_in"> connection </span>tests<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:22 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:47:19 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.200(192.168.177.200:22) <span class="hljs-keyword">to</span> root@192.168.177.201(192.168.177.201:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:20 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:20 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.200(192.168.177.200:22) <span class="hljs-keyword">to</span> root@192.168.177.202(192.168.177.202:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:22 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:23 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:47:20 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.201(192.168.177.201:22) <span class="hljs-keyword">to</span> root@192.168.177.200(192.168.177.200:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:21 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:21 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.201(192.168.177.201:22) <span class="hljs-keyword">to</span> root@192.168.177.202(192.168.177.202:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:22 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:23 2024 - [<span class="hljs-built_in">debug</span>] <br>Wed Oct 16 15:47:20 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.202(192.168.177.202:22) <span class="hljs-keyword">to</span> root@192.168.177.200(192.168.177.200:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:21 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:21 2024 - [<span class="hljs-built_in">debug</span>]  Connecting via SSH <span class="hljs-keyword">from</span> root@192.168.177.202(192.168.177.202:22) <span class="hljs-keyword">to</span> root@192.168.177.201(192.168.177.201:22)<span class="hljs-built_in">..</span><br>Wed Oct 16 15:47:22 2024 - [<span class="hljs-built_in">debug</span>]   ok.<br>Wed Oct 16 15:47:23 2024 - [<span class="hljs-built_in">info</span>] All SSH<span class="hljs-built_in"> connection </span>tests passed successfully.<br></code></pre></td></tr></table></figure>

<p>主从状态检查</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs routeros"> masterha_check_repl  <span class="hljs-attribute">--conf</span>=/etc/mha/mha.cnf<br> <br>[root@localhost mha]# masterha_check_repl  <span class="hljs-attribute">--conf</span>=/etc/mha/mha.cnf<br>Wed Oct 16 15:46:48 2024 - [<span class="hljs-built_in">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="hljs-keyword">not</span> found. Skipping.<br>Wed Oct 16 15:46:48 2024 - [<span class="hljs-built_in">info</span>] Reading application<span class="hljs-built_in"> default </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:48 2024 - [<span class="hljs-built_in">info</span>] Reading<span class="hljs-built_in"> server </span>configuration <span class="hljs-keyword">from</span> /etc/mha/mha.cnf<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:48 2024 - [<span class="hljs-built_in">info</span>] MHA::MasterMonitor version 0.56.<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] GTID failover mode = 1<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Dead Servers:<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Alive Servers:<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]   192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]   192.168.177.201(192.168.177.201:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]   192.168.177.202(192.168.177.202:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Alive Slaves:<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]   192.168.177.201(192.168.177.201:3306)  <span class="hljs-attribute">Version</span>=5.7.41-log (oldest major version between slaves) log-bin:enabled<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]     GTID ON<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]     Replicating <span class="hljs-keyword">from</span> 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]   192.168.177.202(192.168.177.202:3306)  <span class="hljs-attribute">Version</span>=5.7.41-log (oldest major version between slaves) log-bin:enabled<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]     GTID ON<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]     Replicating <span class="hljs-keyword">from</span> 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Current Alive Master: 192.168.177.200(192.168.177.200:3306)<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Checking slave configurations<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]  <span class="hljs-attribute">read_only</span>=1 is <span class="hljs-keyword">not</span> <span class="hljs-built_in">set</span> on slave 192.168.177.201(192.168.177.201:3306).<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]  <span class="hljs-attribute">read_only</span>=1 is <span class="hljs-keyword">not</span> <span class="hljs-built_in">set</span> on slave 192.168.177.202(192.168.177.202:3306).<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Checking replication filtering settings<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]  binlog_do_db= , binlog_ignore_db= <br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>]  Replication filtering check ok.<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="hljs-keyword">and</span> Node package checking.<br>Wed Oct 16 15:46:49 2024 - [<span class="hljs-built_in">info</span>] Checking SSH publickey authentication<span class="hljs-built_in"> settings </span>on the current master<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>] HealthCheck: SSH <span class="hljs-keyword">to</span> 192.168.177.200 is reachable.<br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>] <br>192.168.177.200(192.168.177.200:3306) (current master)<br> +--192.168.177.201(192.168.177.201:3306)<br> +--192.168.177.202(192.168.177.202:3306)<br><br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>] Checking replication<span class="hljs-built_in"> health </span>on 192.168.177.201<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>]  ok.<br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>] Checking replication<span class="hljs-built_in"> health </span>on 192.168.177.202<span class="hljs-built_in">..</span><br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>]  ok.<br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">warning</span>] master_ip_failover_script is <span class="hljs-keyword">not</span> defined.<br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">warning</span>] shutdown_script is <span class="hljs-keyword">not</span> defined.<br>Wed Oct 16 15:46:50 2024 - [<span class="hljs-built_in">info</span>] Got exit code 0 (<span class="hljs-keyword">Not</span> master dead).<br><br>MySQL Replication<span class="hljs-built_in"> Health </span>is OK.<br></code></pre></td></tr></table></figure>

<p>开启MHA</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">nohup masterha_manager --conf=<span class="hljs-regexp">/etc/m</span>ha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; <span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>&gt; <span class="hljs-regexp">/web/</span>logs/mysql/mha/manager.<span class="hljs-built_in">log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;<br></code></pre></td></tr></table></figure>

<p>查看MHA工作状态</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">masterha_check_status --conf=/etc/mha/mha.cnf<br><br>[root@localhost mha]# masterha<span class="hljs-emphasis">_check_status --conf=/etc/mha/mha.cnf</span><br><span class="hljs-emphasis">mha (pid:7022) is running(0:PING_</span>OK), master:192.168.177.200<br><br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.200 -e &quot;show variables like <span class="hljs-emphasis">&#x27;server_id&#x27;</span>&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br><span class="hljs-code">+---------------+</span>-------+<br><span class="hljs-section">| Variable_name | Value |</span><br><span class="hljs-section">+---------------+-------+</span><br><span class="hljs-section">| server_id     | 1     |</span><br><span class="hljs-section">+---------------+-------+</span><br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.201 -e &quot;show variables like <span class="hljs-emphasis">&#x27;server_id&#x27;</span>&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br><span class="hljs-code">+---------------+</span>-------+<br><span class="hljs-section">| Variable_name | Value |</span><br><span class="hljs-section">+---------------+-------+</span><br><span class="hljs-section">| server_id     | 2     |</span><br><span class="hljs-section">+---------------+-------+</span><br>[root@localhost mha]# mysql -umha -p123456 -h 192.168.177.202 -e &quot;show variables like <span class="hljs-emphasis">&#x27;server_id&#x27;</span>&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br><span class="hljs-code">+---------------+</span>-------+<br><span class="hljs-section">| Variable_name | Value |</span><br><span class="hljs-section">+---------------+-------+</span><br><span class="hljs-section">| server_id     | 3     |</span><br><span class="hljs-section">+---------------+-------+</span><br></code></pre></td></tr></table></figure>

<h3 id="故障模拟及处理"><a href="#故障模拟及处理" class="headerlink" title="故障模拟及处理"></a>故障模拟及处理</h3><p>停主库</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-regexp">/etc/</span><span class="hljs-keyword">init</span>.d<span class="hljs-operator">/</span>mysql stop<br><br>观察manager的日志 tail <span class="hljs-operator">-</span>100f <span class="hljs-regexp">/web/</span>logs<span class="hljs-regexp">/mysql/</span>mha<span class="hljs-operator">/</span>manager.log<br>末尾必须显示successfully，才算正常切换成功<span class="hljs-operator">。</span>  <br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs routeros">root@localhost mha]# cat /etc/mha/mha.cnf <br>[server default]<br><span class="hljs-attribute">manager_log</span>=/web/logs/mysql/mha/manager<br><span class="hljs-attribute">manager_workdir</span>=/web/logs/mysql/mha<br><span class="hljs-attribute">master_binlog_dir</span>=/web/logs/mysql/binlog/<br><span class="hljs-attribute">password</span>=123456<br><span class="hljs-attribute">ping_interval</span>=2<br><span class="hljs-attribute">repl_password</span>=123456<br><span class="hljs-attribute">repl_user</span>=repl<br><span class="hljs-attribute">ssh_user</span>=root<br><span class="hljs-attribute">user</span>=mha<br><br>[server2]<br><span class="hljs-attribute">hostname</span>=192.168.177.201<br><span class="hljs-attribute">port</span>=3306<br><br>[server3]<br><span class="hljs-attribute">hostname</span>=192.168.177.202<br><span class="hljs-attribute">port</span>=3306<br><br>mysql&gt; show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master <span class="hljs-keyword">to</span> send event<br>                  Master_Host: 192.168.177.201<br>                  Master_User: repl<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 1713<br>               Relay_Log_File: localhost-relay-bin.000002<br>                Relay_Log_Pos: 414<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: <span class="hljs-literal">Yes</span><br>            Slave_SQL_Running: <span class="hljs-literal">Yes</span><br>            <br>[root@localhost mha]# tail -f /web/logs/mysql/mha/manager<br>Master 192.168.177.200(192.168.177.200:3306) is down!<br><br>Check MHA Manager logs at localhost.localdomain:/web/logs/mysql/mha/manager <span class="hljs-keyword">for</span> details.<br><br>Started automated(non-interactive) failover.<br>Selected 192.168.177.201(192.168.177.201:3306) as a new master.<br>192.168.177.201(192.168.177.201:3306): OK: Applying all logs succeeded.<br>192.168.177.202(192.168.177.202:3306): OK: Slave started, replicating <span class="hljs-keyword">from</span> 192.168.177.201(192.168.177.201:3306)<br>192.168.177.201(192.168.177.201:3306): Resetting slave <span class="hljs-built_in">info</span> succeeded.<br>Master failover <span class="hljs-keyword">to</span> 192.168.177.201(192.168.177.201:3306) completed successfully<br></code></pre></td></tr></table></figure>

<p>恢复主库</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-regexp">/etc/</span><span class="hljs-keyword">init</span>.d<span class="hljs-operator">/</span>mysql start<br></code></pre></td></tr></table></figure>

<p>恢复主从结构(主库执行)</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">tail -200f /web/logs/mysql/mha/manager  可以查看到构建主从的语句<br>CHANGE MASTER <span class="hljs-keyword">TO</span> <span class="hljs-attribute">MASTER_HOST</span>=<span class="hljs-string">&#x27;192.168.177.201&#x27;</span>, <span class="hljs-attribute">MASTER_PORT</span>=3306, <span class="hljs-attribute">MASTER_AUTO_POSITION</span>=1, <span class="hljs-attribute">MASTER_USER</span>=<span class="hljs-string">&#x27;repl&#x27;</span>, <span class="hljs-attribute">MASTER_PASSWORD</span>=<span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>恢复Manager配置文件</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">vim /etc/mha/mha.cnf <br>[server1]                                   <br><span class="hljs-attribute">hostname</span><span class="hljs-operator">=</span><span class="hljs-number">192.168</span>.<span class="hljs-number">177.200</span><br><span class="hljs-attribute">port</span><span class="hljs-operator">=</span><span class="hljs-number">3306</span> <br></code></pre></td></tr></table></figure>

<p>启动MHA</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">nohup masterha_manager --conf=<span class="hljs-regexp">/etc/m</span>ha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; <span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>&gt; <span class="hljs-regexp">/web/</span>logs/mysql/mha/manager.<span class="hljs-built_in">log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;<br></code></pre></td></tr></table></figure>

<h3 id="主从库已变更"><a href="#主从库已变更" class="headerlink" title="主从库已变更"></a>主从库已变更</h3><table>
<thead>
<tr>
<th>从库1</th>
<th>主库</th>
<th>从库2</th>
<th>MySQL版本</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
<td>5.7.41</td>
</tr>
</tbody></table>
<h3 id="MHA-vip配置"><a href="#MHA-vip配置" class="headerlink" title="MHA vip配置"></a>MHA vip配置</h3><p>参数</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal">master_ip_failover_script=<span class="hljs-regexp">/etc/mha</span><span class="hljs-regexp">/master_ip_failover</span><br><span class="hljs-regexp">注意：/etc</span><span class="hljs-regexp">/mha/master</span>_ip_failover，必须事先准备好<br></code></pre></td></tr></table></figure>

<p>添加脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim  /etc/mha/master_ip_failover<br><br><span class="hljs-built_in">chmod</span> +x /etc/mha/master_ip_failover<br>dos2unix /etc/mha/master_ip_failover    转换中文字符<br></code></pre></td></tr></table></figure>

<p>vip漂移脚本</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#!/usr/bin/env perl</span><br><br><span class="hljs-keyword">use</span> strict;<br><span class="hljs-keyword">use</span> warnings <span class="hljs-string">FATAL =&gt;</span> <span class="hljs-string">&#x27;all&#x27;</span>;<br><span class="hljs-keyword">use</span> Getopt::Long;<br><br><span class="hljs-keyword">my</span> (<br>    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,<br>    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port<br>);<br><br><span class="hljs-keyword">my</span> $vip = <span class="hljs-string">&#x27;192.168.177.218/24&#x27;</span>;<br><span class="hljs-keyword">my</span> $key = <span class="hljs-string">&#x27;1&#x27;</span>;<br><span class="hljs-keyword">my</span> $ssh_start_vip = <span class="hljs-string">&quot;/sbin/ifconfig ens33:$key $vip&quot;</span>;<br><span class="hljs-keyword">my</span> $ssh_stop_vip = <span class="hljs-string">&quot;/sbin/ifconfig ens33:$key down&quot;</span>; <span class="hljs-comment"># 确保接口名称一致</span><br><br>GetOptions(<br>    <span class="hljs-string">&#x27;command=s&#x27;</span>          =&gt; \$command,<br>    <span class="hljs-string">&#x27;ssh_user=s&#x27;</span>         =&gt; \$ssh_user,<br>    <span class="hljs-string">&#x27;orig_master_host=s&#x27;</span> =&gt; \$orig_master_host,<br>    <span class="hljs-string">&#x27;orig_master_ip=s&#x27;</span>   =&gt; \$orig_master_ip,<br>    <span class="hljs-string">&#x27;orig_master_port=i&#x27;</span> =&gt; \$orig_master_port,<br>    <span class="hljs-string">&#x27;new_master_host=s&#x27;</span>  =&gt; \$new_master_host,<br>    <span class="hljs-string">&#x27;new_master_ip=s&#x27;</span>    =&gt; \$new_master_ip,<br>    <span class="hljs-string">&#x27;new_master_port=i&#x27;</span>  =&gt; \$new_master_port,<br>);<br><br><span class="hljs-keyword">exit</span> &amp;main();<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">main</span> </span>&#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;\n\nIN Master_ip_failover_command:====$command===\n\n&quot;</span>;<br><br>    <span class="hljs-keyword">if</span> ( $command eq <span class="hljs-string">&quot;stop&quot;</span> || $command eq <span class="hljs-string">&quot;stopssh&quot;</span> ) &#123;<br>        <span class="hljs-keyword">my</span> $exit_code = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">eval</span> &#123;<br>            <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Disabling the VIP on old master: $orig_master_host \n&quot;</span>;<br>            stop_vip();<br>            $exit_code = <span class="hljs-number">0</span>;<br>        &#125;;<br>        <span class="hljs-keyword">if</span> ($@) &#123;<br>            <span class="hljs-keyword">warn</span> <span class="hljs-string">&quot;Got Error: $@\n&quot;</span>;<br>            <span class="hljs-keyword">exit</span> $exit_code;<br>        &#125;<br>        <span class="hljs-keyword">exit</span> $exit_code;<br>    &#125;<br>    <span class="hljs-keyword">elsif</span> ( $command eq <span class="hljs-string">&quot;start&quot;</span> ) &#123;<br>        <span class="hljs-keyword">my</span> $exit_code = <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">eval</span> &#123;<br>            <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;</span>;<br>            start_vip();<br>            $exit_code = <span class="hljs-number">0</span>;<br>        &#125;;<br>        <span class="hljs-keyword">if</span> ($@) &#123;<br>            <span class="hljs-keyword">warn</span> $@;<br>            <span class="hljs-keyword">exit</span> $exit_code;<br>        &#125;<br>        <span class="hljs-keyword">exit</span> $exit_code;<br>    &#125;<br>    <span class="hljs-keyword">elsif</span> ( $command eq <span class="hljs-string">&quot;status&quot;</span> ) &#123;<br>        <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Checking the Status of the script.. OK \n&quot;</span>;<br>        <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        usage();<br>        <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">start_vip</span> </span>&#123;<br>    <span class="hljs-keyword">my</span> $output = <span class="hljs-string">qx&#123;ssh $ssh_user\@$new_master_host &quot;$ssh_start_vip&quot;&#125;</span>;<br>    <span class="hljs-keyword">if</span> ($?) &#123;<br>        <span class="hljs-keyword">die</span> <span class="hljs-string">&quot;Failed to start VIP: $output&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">stop_vip</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">unless</span> ($ssh_user);<br>    <span class="hljs-keyword">my</span> $output = <span class="hljs-string">qx&#123;ssh $ssh_user\@$orig_master_host &quot;$ssh_stop_vip&quot;&#125;</span>;<br>    <span class="hljs-keyword">if</span> ($?) &#123;<br>        <span class="hljs-keyword">die</span> <span class="hljs-string">&quot;Failed to stop VIP: $output&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">usage</span> </span>&#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>更改Manager配置文件 添加脚本</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">vim <span class="hljs-regexp">/etc/m</span>ha/mha.cnf<br>[server <span class="hljs-keyword">default</span>]<br>master_ip_failover_script=<span class="hljs-regexp">/etc/m</span>ha/master_ip_failover<br></code></pre></td></tr></table></figure>

<p>第一次配置vip时候，需要在主库手工生成vip</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns">手工在主库上绑定vip，注意一定要和配置文件中的ethN一致，eth33:<span class="hljs-number">1</span>(<span class="hljs-number">1</span>是key指定的值)<br>yum install net-tools -y                 #没有ifconfig命令执行<br>ifconfig ens<span class="hljs-number">33:1 192.168</span>.<span class="hljs-number">177.218/24</span><br>ip address add <span class="hljs-number">192.168.228.218</span>/<span class="hljs-number">24</span> dev ens33:<span class="hljs-number">1</span><br>ifconfig<br></code></pre></td></tr></table></figure>

<p>重启Manager</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">masterha_stop <span class="hljs-attr">--conf</span>=/etc/mha/mha<span class="hljs-selector-class">.cnf</span><br>nohup masterha_manager <span class="hljs-attr">--conf</span>=/etc/mha/mha<span class="hljs-selector-class">.cnf</span> <span class="hljs-attr">--remove_dead_master_conf</span> <span class="hljs-attr">--ignore_last_failover</span>  &lt; /dev/null&gt; /web/logs/mysql/mha/manager<span class="hljs-selector-class">.log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;<br><br>检查状态<br>masterha_check_status <span class="hljs-attr">--conf</span>=/etc/mha/mha<span class="hljs-selector-class">.cnf</span><br>mha (pid:<span class="hljs-number">8652</span>) is <span class="hljs-built_in">running</span>(<span class="hljs-number">0</span>:PING_OK), master:<span class="hljs-number">192.168</span>.<span class="hljs-number">177.201</span><br></code></pre></td></tr></table></figure>

<h4 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h4><p>查看主库vip</p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113416352.png" srcset="/img/loading.gif" lazyload></p>
<p>停止主库</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-regexp">/etc/</span><span class="hljs-keyword">init</span>.d<span class="hljs-operator">/</span>mysql stop<br></code></pre></td></tr></table></figure>

<p>查看主库vip及从库vip</p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113503674.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241017113517921.png" srcset="/img/loading.gif" lazyload></p>
<p>恢复主库</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">启动<br>/etc/init.d/mysql stop<br>构建主从关系<br>CHANGE MASTER <span class="hljs-keyword">TO</span> <span class="hljs-attribute">MASTER_HOST</span>=<span class="hljs-string">&#x27;192.168.177.200&#x27;</span>, <span class="hljs-attribute">MASTER_PORT</span>=3306, <span class="hljs-attribute">MASTER_AUTO_POSITION</span>=1, <span class="hljs-attribute">MASTER_USER</span>=<span class="hljs-string">&#x27;repl&#x27;</span>, <span class="hljs-attribute">MASTER_PASSWORD</span>=<span class="hljs-string">&#x27;123456&#x27;</span>;<br>启动slave<br>start slave;<br></code></pre></td></tr></table></figure>

<p>启动Manager并查看状态</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@localhost</span> mha]# nohup masterha_manager <span class="hljs-operator">--</span>conf<span class="hljs-operator">=/</span>etc<span class="hljs-regexp">/mha/</span>mha.cnf <span class="hljs-operator">--</span>remove_dead_master_conf <span class="hljs-operator">--</span>ignore_last_failover  <span class="hljs-operator">&lt;</span> <span class="hljs-regexp">/dev/</span>null<span class="hljs-operator">&gt;</span> <span class="hljs-regexp">/web/</span>logs<span class="hljs-regexp">/mysql/</span>mha<span class="hljs-operator">/</span>manager.log <span class="hljs-number">2</span><span class="hljs-operator">&gt;&amp;</span><span class="hljs-number">1</span> <span class="hljs-operator">&amp;</span><br>[<span class="hljs-number">1</span>] <span class="hljs-number">8652</span><br>[root<span class="hljs-meta">@localhost</span> mha]# masterha_check_status <span class="hljs-operator">--</span>conf<span class="hljs-operator">=/</span>etc<span class="hljs-regexp">/mha/</span>mha.cnf<br>mha (pid:<span class="hljs-number">8652</span>) <span class="hljs-keyword">is</span> running(<span class="hljs-number">0</span>:<span class="hljs-type">PING_OK</span>), master:<span class="hljs-number">192.168</span>.<span class="hljs-number">177.200</span><br></code></pre></td></tr></table></figure>

<h3 id="邮件提醒"><a href="#邮件提醒" class="headerlink" title="邮件提醒"></a>邮件提醒</h3><p>参数</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">report_script</span>=/etc/mha/mail<br></code></pre></td></tr></table></figure>

<p>Manager增加配置</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">mkdir -p <span class="hljs-regexp">/etc/m</span>ha<span class="hljs-regexp">/mail/</span><br>vim <span class="hljs-regexp">/etc/m</span>ha/mha.cnf<br>[server <span class="hljs-keyword">default</span>]<br>report_script=<span class="hljs-regexp">/etc/m</span>ha<span class="hljs-regexp">/mail/</span>send<br></code></pre></td></tr></table></figure>

<p>重启MHA</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">masterha_stop <span class="hljs-attr">--conf</span>=/etc/mha/mha<span class="hljs-selector-class">.cnf</span><br>nohup masterha_manager <span class="hljs-attr">--conf</span>=/etc/mha/mha<span class="hljs-selector-class">.cnf</span> <span class="hljs-attr">--remove_dead_master_conf</span> <span class="hljs-attr">--ignore_last_failover</span>  &lt; /dev/null&gt; /web/logs/mysql/mha/manager<span class="hljs-selector-class">.log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;<br></code></pre></td></tr></table></figure>

<h3 id="Binlog-Server"><a href="#Binlog-Server" class="headerlink" title="Binlog Server"></a>Binlog Server</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">避免主MHA连接不上主库，导致从库数据差异，数据丢失  需要配置额外服务器<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">mkdir /web/data/mysql/binserver<br><br>vim /etc/mha/app1.cnf <br>[binlog1]<br><span class="hljs-attribute">no_master</span>=1<br><span class="hljs-attribute">hostname</span>=192.168.177.202<br><span class="hljs-comment">#不能跟原binlog目录一样</span><br><span class="hljs-attribute">master_binlog_dir</span>=/web/data/mysql/binserver/<br></code></pre></td></tr></table></figure>

<p>拉去主库binlog日志</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown">将当前主库binlog拉过来（从00000X开始拉，之后的binlog会自动按顺序过来）<br>进入创建的目录<br>cd /web/data/mysql/binserver/<br>mysqlbinlog  -R --host=192.168.177.201 --user=mha --password=123456 --raw  --stop-never mysql-bin.000009 &amp;<br><br>注意：<br>拉取日志的起点,需要按照目前从库的已经获取到的二进制日志点为起点<br>mysql&gt; show slave status \G;<br><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">*** 1. row **</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*<br><span class="hljs-code">                  Master_Host: 192.168.177.201</span><br><span class="hljs-code">              Master_Log_File: mysql-bin.000009</span><br><span class="hljs-code"></span><br>-R：表示以只读模式执行，防止对日志文件进行写入操作。<br>--host=192.168.177.200：指定要连接的主库的 IP 地址。<br>--user=mha：连接主库服务器的用户名。<br>--password=123456：连接主库服务器的密码。<br>--raw：以原始格式输出二进制日志内容。<br>--stop-never：持续运行，不断读取新产生的日志内容，不会自动停止<br></code></pre></td></tr></table></figure>

<p>启动MHA</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">nohup masterha_manager --conf=<span class="hljs-regexp">/etc/m</span>ha/mha.cnf --remove_dead_master_conf --ignore_last_failover  &lt; <span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>&gt; <span class="hljs-regexp">/web/</span>logs/mysql/mha/manager.<span class="hljs-built_in">log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;<br></code></pre></td></tr></table></figure>

<h4 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">主库宕机，<span class="hljs-keyword">binlogserver </span>自动停掉，manager 也会自动停止。<br>处理思路：<br><span class="hljs-number">1</span>、删除之前的<span class="hljs-keyword">binlog，重新获取新主库的binlog到binlogserver中</span><br><span class="hljs-keyword"></span><span class="hljs-number">2</span>、重新配置文件<span class="hljs-keyword">binlog </span>server信息<br><span class="hljs-number">3</span>、最后再启动MHA<br></code></pre></td></tr></table></figure>

<p>设置从库多线程并发复制</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">指定从库用于并行执行 <span class="hljs-keyword">SQL</span> 线程的数量<br><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slave_parallel_workers = <span class="hljs-number">4</span>;<br>slave_parallel_type：设置并行复制的类型<br><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slave_parallel_type=<span class="hljs-string">&#x27;LOGICAL_CLOCK&#x27;</span>;<br>重启复制线程<br>STOP SLAVE;<br><span class="hljs-keyword">START</span> SLAVE;<br></code></pre></td></tr></table></figure>

<h3 id="Atlas读写分离"><a href="#Atlas读写分离" class="headerlink" title="Atlas读写分离"></a>Atlas读写分离</h3><p>MHA+Atlas</p>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105629154.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018105634345.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Atlas是由 Qihoo <span class="hljs-number">360</span>, Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。它是在mysql-proxy <span class="hljs-number">0.8</span>.<span class="hljs-number">2</span>版本的基础上，对其进行了优化，增加了一些新的功能特性。<br><span class="hljs-number">360</span>内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。<br>下载地址<br>https:<span class="hljs-comment">//github.com/Qihoo360/Atlas/releases</span><br>注意：<br><span class="hljs-number">1</span>、Atlas只能安装运行在<span class="hljs-number">64</span>位的系统上<br><span class="hljs-number">2</span>、Centos <span class="hljs-number">5</span>.X安装 Atlas-XX<span class="hljs-selector-class">.el5</span><span class="hljs-selector-class">.x86_64</span>.rpm，Centos <span class="hljs-number">6</span>.X安装Atlas-XX<span class="hljs-selector-class">.el6</span><span class="hljs-selector-class">.x86_64</span>.rpm。<br><span class="hljs-number">3</span>、后端mysql版本应大于<span class="hljs-number">5.1</span>，建议使用Mysql <span class="hljs-number">5.6</span>以上<br></code></pre></td></tr></table></figure>

<p>下载</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">https</span>://objects.githubusercontent.com/github-production-release-asset-<span class="hljs-number">2</span>e65be/<span class="hljs-number">15279980</span>/<span class="hljs-number">39</span>ac0594-<span class="hljs-number">8600</span>-<span class="hljs-number">11</span>e4-<span class="hljs-number">9</span>ad6-<span class="hljs-number">7</span>fc203cad2de?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=releaseassetproduction%<span class="hljs-number">2</span>F20241018%<span class="hljs-number">2</span>Fus-east-<span class="hljs-number">1</span>%<span class="hljs-number">2</span>Fs3%<span class="hljs-number">2</span>Faws4_request&amp;X-Amz-Date=<span class="hljs-number">20241018</span>T030903Z&amp;X-Amz-Expires=<span class="hljs-number">300</span>&amp;X-Amz-Signature=<span class="hljs-number">5</span>bfd9678cb16fee876e6f6a3af89b858a41f5840485524604c559ab8da9bc290&amp;X-Amz-SignedHeaders=host&amp;response-content-disposition=attachment%<span class="hljs-number">3</span>B%<span class="hljs-number">20</span>filename%<span class="hljs-number">3</span>DAtlas-<span class="hljs-number">2</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>.el6.x86_64.rpm&amp;response-content-type=application%<span class="hljs-number">2</span>Foctet-stream<br></code></pre></td></tr></table></figure>

<h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><p>安装</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">rpm -ivh Atlas-<span class="hljs-number">2.2</span>.<span class="hljs-number">1</span><span class="hljs-selector-class">.el6</span><span class="hljs-selector-class">.x86_64</span><span class="hljs-selector-class">.rpm</span><br><br>创建日志文件夹<br>mkdir -<span class="hljs-selector-tag">p</span> /web/logs/mysql/mysql-proxy/<br><br>cd /usr/local/mysql-proxy/<br>mv test<span class="hljs-selector-class">.cnf</span> test<span class="hljs-selector-class">.cnf</span>.bak<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>主库</th>
<th>从库1</th>
<th>从库2</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.177.200</td>
<td>192.168.177.201</td>
<td>192.168.177.202</td>
</tr>
</tbody></table>
<p>密码加密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">进入Atlas下<span class="hljs-built_in">bin</span>目录<br>加密密码<br>[root@localhost <span class="hljs-built_in">bin</span>]<span class="hljs-comment"># ./encrypt 123456</span><br>/iZxz+0GRoA=<br></code></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">vim test.cnf<br><br>[mysql-proxy]<br>#管理Atlas用户名密码<br><span class="hljs-keyword">admin</span>-username = atlas<br><span class="hljs-keyword">admin</span>-<span class="hljs-keyword">password</span> = <span class="hljs-number">123456</span><br>#负责写入的服务器iP<br>proxy-backend-addresses = <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.218</span>:<span class="hljs-number">3306</span><br>#负责读的节点(从库)<br>proxy-<span class="hljs-keyword">read</span>-<span class="hljs-keyword">only</span>-backend-addresses = <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.201</span>:<span class="hljs-number">3306</span>,<span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.202</span>:<span class="hljs-number">3306</span><br>pwds = repl:/iZxz+<span class="hljs-number">0</span>GRoA=,mha:/iZxz+<span class="hljs-number">0</span>GRoA=<br>daemon = <span class="hljs-keyword">true</span><br>keepalive = <span class="hljs-keyword">true</span><br>event-threads = <span class="hljs-number">8</span><br><span class="hljs-keyword">log</span>-<span class="hljs-keyword">level</span> = message<br><span class="hljs-keyword">log</span>-<span class="hljs-type">path</span> = /web/logs/mysql/mysql-proxy/<br>#是否记录操作日志<br><span class="hljs-keyword">sql</span>-<span class="hljs-keyword">log</span>=<span class="hljs-keyword">ON</span><br>proxy-address = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">33060</span><br><span class="hljs-keyword">admin</span>-address = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">2345</span><br>charset=utf8<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql-proxy/</span>bin/mysql-proxyd test start<br></code></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ps</span> -ef |grep proxy<br><span class="hljs-attribute">netstat</span> -lntp |grep <span class="hljs-number">33060</span><br><span class="hljs-attribute">tcp</span>        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0.0.0:33060</span>           <span class="hljs-number">0.0.0.0</span>:*               LISTEN      <span class="hljs-number">55015</span>/mysql-proxy <br><br><span class="hljs-attribute">netstat</span> -lntp |grep <span class="hljs-number">2345</span><br><span class="hljs-attribute">tcp</span>        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0.0.0:2345</span>            <span class="hljs-number">0.0.0.0</span>:*               LISTEN      <span class="hljs-number">55015</span>/mysql-proxy <br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">mysql</span> -u mha -p123456 -h <span class="hljs-number">192.168.177.202</span> -P <span class="hljs-number">33060</span><br>查询<br><span class="hljs-literal">select</span> @<span class="hljs-variable">@server_id</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018155325464.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">写入<br><span class="hljs-keyword">begin</span>;<span class="hljs-keyword">select</span> @<span class="hljs-variable">@server_id</span>;<span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/2024/10/18/MHA%E9%AB%98%E5%8F%AF%E7%94%A8+Atlas%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/image-20241018160652891.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="生产用户要求"><a href="#生产用户要求" class="headerlink" title="生产用户要求"></a>生产用户要求</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">开发人员申请一个应用用户 deploy(  <span class="hljs-keyword">select</span>  <span class="hljs-keyword">update</span>  <span class="hljs-keyword">insert</span>)  密码<span class="hljs-number">123456</span>,要通过<span class="hljs-number">192</span>网段登录<br><span class="hljs-number">1.</span> 在主库中,创建用户<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">select</span> ,<span class="hljs-keyword">update</span>,<span class="hljs-keyword">insert</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> deploy@<span class="hljs-string">&#x27;192.168.177.%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-number">2.</span> 在atlas中添加生产用户<br>/usr/<span class="hljs-keyword">local</span>/mysql-proxy/bin/encrypt  <span class="hljs-number">123456</span>      <span class="hljs-comment">----&gt;制作加密密码</span><br>vim test.cnf<br>pwds = repl:/iZxz+<span class="hljs-number">0</span>GRoA=,mha:/iZxz+<span class="hljs-number">0</span>GRoA=,deploy:/iZxz+<span class="hljs-number">0</span>GRoA=<br><br>/usr/<span class="hljs-keyword">local</span>/mysql-proxy/bin/mysql-proxyd test <span class="hljs-keyword">restart</span><br>mysql -u deploy -p123456 -h <span class="hljs-number">192.168</span><span class="hljs-number">.177</span><span class="hljs-number">.202</span> -P <span class="hljs-number">33060</span><br></code></pre></td></tr></table></figure>

<h3 id="Atlas基本管理"><a href="#Atlas基本管理" class="headerlink" title="Atlas基本管理"></a>Atlas基本管理</h3><p>连接管理接口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<p>打印帮助</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">mysql&gt; select <span class="hljs-symbol">*</span> from help;<br>+----------------------------+---------------------------------------------------------+<br>|<span class="hljs-string"> command                    </span>|<span class="hljs-string"> description                                             </span>|<br>+----------------------------+---------------------------------------------------------+<br>|<span class="hljs-string"> SELECT * FROM help         </span>|<span class="hljs-string"> shows this help                                         </span>|<br>|<span class="hljs-string"> SELECT * FROM backends     </span>|<span class="hljs-string"> lists the backends and their state                      </span>|<br>|<span class="hljs-string"> SET OFFLINE $backend_id    </span>|<span class="hljs-string"> offline backend server, $backend_id is backend_ndx&#x27;s id </span>|<br>|<span class="hljs-string"> SET ONLINE $backend_id     </span>|<span class="hljs-string"> online backend server, ...                              </span>|<br>|<span class="hljs-string"> ADD MASTER $backend        </span>|<span class="hljs-string"> example: &quot;add master 127.0.0.1:3306&quot;, ...               </span>|<br>|<span class="hljs-string"> ADD SLAVE $backend         </span>|<span class="hljs-string"> example: &quot;add slave 127.0.0.1:3306&quot;, ...                </span>|<br>|<span class="hljs-string"> REMOVE BACKEND $backend_id </span>|<span class="hljs-string"> example: &quot;remove backend 1&quot;, ...                        </span>|<br>|<span class="hljs-string"> SELECT * FROM clients      </span>|<span class="hljs-string"> lists the clients                                       </span>|<br>|<span class="hljs-string"> ADD CLIENT $client         </span>|<span class="hljs-string"> example: &quot;add client 192.168.1.2&quot;, ...                  </span>|<br>|<span class="hljs-string"> REMOVE CLIENT $client      </span>|<span class="hljs-string"> example: &quot;remove client 192.168.1.2&quot;, ...               </span>|<br>|<span class="hljs-string"> SELECT * FROM pwds         </span>|<span class="hljs-string"> lists the pwds                                          </span>|<br>|<span class="hljs-string"> ADD PWD $pwd               </span>|<span class="hljs-string"> example: &quot;add pwd user:raw_password&quot;, ...               </span>|<br>|<span class="hljs-string"> ADD ENPWD $pwd             </span>|<span class="hljs-string"> example: &quot;add enpwd user:encrypted_password&quot;, ...       </span>|<br>|<span class="hljs-string"> REMOVE PWD $pwd            </span>|<span class="hljs-string"> example: &quot;remove pwd user&quot;, ...                         </span>|<br>|<span class="hljs-string"> SAVE CONFIG                </span>|<span class="hljs-string"> save the backends to config file                        </span>|<br>|<span class="hljs-string"> SELECT VERSION             </span>|<span class="hljs-string"> display the version of Atlas                            </span>|<br>+----------------------------+---------------------------------------------------------+<br></code></pre></td></tr></table></figure>

<p>查询后端所有节点信息</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">mysql&gt;  SELECT * FROM backends    ;</span><br><span class="hljs-section">+-------------+----------------------+-------+------+</span><br><span class="hljs-section">| backend_ndx | address              | state | type |</span><br><span class="hljs-section">+-------------+----------------------+-------+------+</span><br>|           1 | 192.168.177.218:3306 | up    | rw   |<br>|           2 | 192.168.177.201:3306 | up    | ro   |<br><span class="hljs-section">|           3 | 192.168.177.202:3306 | up    | ro   |</span><br><span class="hljs-section">+-------------+----------------------+-------+------+</span><br></code></pre></td></tr></table></figure>

<p>动态删除节点</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-comment">REMOVE BACKEND 3;</span><br></code></pre></td></tr></table></figure>

<p>动态添加节点</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ADD</span> SLAVE <span class="hljs-number">192.168.177.202:3306</span>;<br></code></pre></td></tr></table></figure>

<p>保存</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">SAVE CONFIG<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/MySQL/" class="category-chain-item">MySQL</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/" class="print-no-link">#Linux</a>
      
        <a href="/tags/MySQL/" class="print-no-link">#MySQL</a>
      
        <a href="/tags/MHA/" class="print-no-link">#MHA</a>
      
        <a href="/tags/Atlas/" class="print-no-link">#Atlas</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MHA高可用+Atlas读写分离</div>
      <div>https://yftxhy.cn/2024/10/18/MHA高可用+Atlas读写分离/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Taozi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年10月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/10/15/MySQL%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA/" title="MySQL主从搭建">
                        <span class="hidden-mobile">MySQL主从搭建</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
